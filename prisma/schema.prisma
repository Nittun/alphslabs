// Prisma Schema for Alphalabs Trading Platform
// Supports PostgreSQL (AWS RDS) or MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores user information from OAuth or email/password
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // Hashed password for email/password auth (null for OAuth users)
  name          String?
  firstName     String?
  lastName      String?
  image         String?
  bio           String?
  role          String    @default("user") // "user", "moderator", or "admin"
  authProvider  String    @default("credentials") // "google", "credentials"
  emailVerified DateTime? // For future email verification
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Default trading configuration (JSON)
  defaultConfig Json?
  
  // Relations
  loginHistory            LoginHistory[]
  backtestConfigs         BacktestConfig[]
  backtestRuns            BacktestRun[]
  manualBacktestStrategies ManualBacktestStrategy[]
  optimizationConfigs     OptimizationConfig[]
  userStrategies          UserStrategy[]
  surveyResponses         SurveyResponse[]
  
  @@map("users")
}

// Login History - tracks user login sessions
model LoginHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  loginAt     DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  provider    String?
  
  @@index([userId])
  @@map("login_history")
}

// Backtest Configuration - stores saved configurations for quick access (auto mode)
model BacktestConfig {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  asset         String
  interval      String
  daysBack      Int      @default(730)
  initialCapital Float   @default(10000)
  enableShort   Boolean  @default(true)
  strategyMode  String   @default("reversal")
  emaFast       Int      @default(12)
  emaSlow       Int      @default(26)
  isFavorite    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  backtestRuns  BacktestRun[]
  
  @@index([userId])
  @@map("backtest_configs")
}

// Manual Backtest Strategy - stores manual backtest configurations with trades
model ManualBacktestStrategy {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  asset         String
  timeframe     String
  startDate     String
  endDate       String
  indicators    Json     // Array of indicator configs
  trades        Json?    // Array of manual trades
  performance   Json?    // Performance metrics
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@map("manual_backtest_strategies")
}

// Optimization Configuration - stores saved optimization setups
model OptimizationConfig {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  config        Json     // Full optimization configuration
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@map("optimization_configs")
}

// User Strategy - stores strategies created in Indicator Sandbox
model UserStrategy {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  dsl           String?  @db.Text // JSON-based strategy DSL
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@map("user_strategies")
}

// Backtest Run - stores each backtest execution with results
model BacktestRun {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  configId        String?
  config          BacktestConfig? @relation(fields: [configId], references: [id], onDelete: SetNull)
  
  // Configuration snapshot
  asset           String
  interval        String
  daysBack        Int
  initialCapital  Float
  enableShort     Boolean
  strategyMode    String
  emaFast         Int
  emaSlow         Int
  
  // Results
  totalReturn     Float?
  totalReturnPct  Float?
  winRate         Float?
  totalTrades     Int?
  winningTrades   Int?
  losingTrades    Int?
  maxDrawdown     Float?
  sharpeRatio     Float?
  
  // Trade logs stored as JSON
  tradeLogs       Json?
  
  runAt           DateTime @default(now())
  
  @@index([userId])
  @@index([configId])
  @@index([runAt])
  @@map("backtest_runs")
}

// Job Queue - tracks all queued jobs for monitoring
model Job {
  id              String   @id @default(cuid())
  userId          String?
  type            String   // "backtest", "optimize", "monte_carlo", etc.
  status          String   @default("queued") // "queued", "running", "completed", "failed", "cancelled"
  priority        Int      @default(0)
  
  // Timing metrics
  queuedAt        DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Runtime in milliseconds
  runtimeMs       Int?
  waitTimeMs      Int?
  
  // Job details
  payload         Json?
  result          Json?
  error           String?
  
  // Compute metrics
  computeUnits    Float?   // Estimated compute cost
  
  @@index([userId])
  @@index([status])
  @@index([queuedAt])
  @@index([type])
  @@map("jobs")
}

// Rate Limit Hits - tracks rate limiting events
model RateLimitHit {
  id              String   @id @default(cuid())
  userId          String?
  ipAddress       String?
  endpoint        String
  hitAt           DateTime @default(now())
  blocked         Boolean  @default(false)
  abuseFlag       Boolean  @default(false)
  
  @@index([userId])
  @@index([ipAddress])
  @@index([hitAt])
  @@map("rate_limit_hits")
}

// Feature Usage - tracks which features are used
model FeatureUsage {
  id              String   @id @default(cuid())
  userId          String?
  feature         String   // "backtest_auto", "backtest_manual", "optimize", "monte_carlo", "stress_test", etc.
  usedAt          DateTime @default(now())
  metadata        Json?    // Additional context
  
  @@index([feature])
  @@index([usedAt])
  @@map("feature_usage")
}

// Admin Audit Log - tracks admin actions
model AdminAuditLog {
  id              String   @id @default(cuid())
  adminId         String
  action          String   // "role_change", "user_delete", "permission_update", etc.
  targetUserId    String?
  details         Json?
  ipAddress       String?
  createdAt       DateTime @default(now())
  
  @@index([adminId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// System Alerts - tracks system issues and alerts
model SystemAlert {
  id              String   @id @default(cuid())
  type            String   // "error_spike", "delayed_ingestion", "high_load", "security"
  severity        String   @default("warning") // "info", "warning", "error", "critical"
  message         String
  details         Json?
  resolved        Boolean  @default(false)
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())
  
  @@index([type])
  @@index([resolved])
  @@index([createdAt])
  @@map("system_alerts")
}

// Data Ingestion Status - tracks data freshness
model DataIngestionStatus {
  id              String   @id @default(cuid())
  source          String   // "binance", "coingecko", etc.
  lastSuccessAt   DateTime?
  lastErrorAt     DateTime?
  lastError       String?
  status          String   @default("healthy") // "healthy", "delayed", "error"
  dataLagSeconds  Int?
  updatedAt       DateTime @updatedAt
  
  @@unique([source])
  @@map("data_ingestion_status")
}

// User Feedback - stores feedback messages from help page
model Feedback {
  id              String   @id @default(cuid())
  name            String
  email           String
  subject         String   @default("general") // "general", "bug", "feature", "feedback", "other"
  message         String
  status          String   @default("unread") // "unread", "read", "replied", "archived"
  priority        String   @default("normal") // "low", "normal", "high", "urgent"
  adminNotes      String?
  repliedAt       DateTime?
  repliedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([createdAt])
  @@index([email])
  @@map("feedback")
}

// Product Survey - stores structured product feedback and pricing willingness
model SurveyResponse {
  id                   String   @id @default(cuid())

  // Optional linkage to authenticated user
  userId               String?
  user                 User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userEmail            String?

  // 1-10 ratings
  usefulRating         Int
  uiRating             Int
  functionRating       Int
  featuresRating       Int
  performanceRating    Int
  overallRating        Int

  // Free text
  requestedFeatures    String?  @db.Text
  additionalComments   String?  @db.Text

  // Pricing willingness
  willingToPayAmount   Float?
  willingToPayCurrency String?  @default("USD")

  // Context
  ipAddress            String?
  userAgent            String?

  createdAt            DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([overallRating])
  @@map("survey_responses")
}
